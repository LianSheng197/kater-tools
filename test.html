<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
    <textarea id='paste_target' style="width: 98vw; height: 300px; border: 1px solid #000;"></textarea>
    <div id="display"></div>
    <script>
        let editableDiv = document.querySelector("#paste_target");

        editableDiv.addEventListener('paste', handlepaste);

        function handlepaste(e) {
            let types, pastedData, savedContent;

            // 在 Clipboard API 中支援 'text/html' 格式的瀏覽器 (Chrome, Firefox 22+)
            if (e && e.clipboardData && e.clipboardData.types && e.clipboardData.getData) {
                types = e.clipboardData.types;

                if (((types instanceof DOMStringList) && types.contains("text/html")) ||
                    (types.indexOf && types.indexOf('text/html') !== -1)) {
                    pastedData = e.clipboardData.getData('text/html');
                    processPaste(editableDiv, pastedData);

                    // 避免預設動作、阻止事件冒泡
                    e.stopPropagation();
                    e.preventDefault();

                    return false;
                }
            }

            savedContent = document.createDocumentFragment();
            while (editableDiv.childNodes.length > 0) {
                savedContent.appendChild(editableDiv.childNodes[0]);
            }

            waitForPastedData(editableDiv, savedContent);
            return true;
        }

        function waitForPastedData(element, savedContent) {
            // 判斷是否已處理完成，否則等待一段時間後再試一次
            if (element.childNodes && element.childNodes.length > 0) {
                var pastedData = element.innerHTML;

                // Restore saved content
                element.innerHTML = "";
                element.appendChild(savedContent);

                processPaste(element, pastedData);
            } else {
                setTimeout(function () {
                    waitForPastedData(element, savedContent)
                }, 20);
            }
        }

        function processPaste(element, pastedData) {
            element.focus();
            document.querySelector("div#display").innerHTML = pastedData;

            console.log(pastedData);

            const regex = /<[^<>\/]+?\ style=\".*?(?<!-)color:(.+?);.*?\">([^<>]+?)<\/.+?>/gm;
            let m;

            let string = "";
            while ((m = regex.exec(pastedData)) !== null) {
                // 避免無限循環
                if (m.index === regex.lastIndex) {
                    regex.lastIndex++;
                }

                m.forEach(function (match, groupIndex) {
                    // 顏色代碼
                    if (groupIndex == 1) {
                        // 支援兩種最常用的格式，hsl() 等罕見用法就放生了吧XD
                        if (match.includes("rgb")) {
                            // 格式：rgb(rrr, ggg, bbb)
                            let colors = match.replace(/[^0-9,]/g, "").split(",");

                            let hex = "";
                            colors.forEach(function (each) {
                                hex += ("0" + parseInt(each).toString(16)).slice(-2);
                            })
                            
                            string += `[color=#${hex}]`;
                        } else {
                            // 預設格式：#rrggbb
                            match = match.replace(" ", "");
                            string += `[color=${match}]`;
                        }
                    }
                    // 要上色的文字
                    if (groupIndex == 2) {
                        string += `${match}[/color]`;
                    }
                });
            }

            string = unescape(string);
            // 避免小括號被解析成連結
            string = replaceAll(string, "\(", "\\(");
            string = replaceAll(string, "\)", "\\)");

            // 避免重音符 (backtick) 被解析成程式碼區塊
            string = replaceAll(string, "`", "\\`");
            string = replaceAll(string, " ", " ");

            // 替換殘留 HTML Entity （不知道爲什麼 unescape 沒有全部替換）
            string = replaceAll(string, "&gt;", ">");
            string = replaceAll(string, "&lt;", "<");
            string = replaceAll(string, "&amp;", "&");

            editableDiv.value = string;
        }

        function replaceAll(str, find, replace) {
            function escapeRegExp(string) {
                return string.replace(/[.*+\-?^${}()|[\]\\]/g, '\\$&');
            }

            return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
        }
    </script>
</body>

</html>